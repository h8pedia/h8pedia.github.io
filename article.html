<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article â€” h8pedia</title>
  <link rel="stylesheet" href="css/styles.css">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="site-logo">h8<span>pedia</span></a>
      <div class="header-search">
        <input type="text" id="headerSearch" placeholder="Search articles..." aria-label="Search articles">
        <button type="button" onclick="doSearch()" aria-label="Search">&#x1F50D;</button>
      </div>
      <nav class="header-nav" id="headerNav">
        <div class="nav-left">
          <a href="index.html" class="nav-link active">Home</a>
          <a href="categories.html" class="nav-link">Categories</a>
          <a href="search.html" class="nav-link">Search</a>
        </div>
        <div id="navAuth" class="nav-right"></div>
      </nav>

      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">&#9776;</button>
    </div>
  </header>

  <main class="page-wrapper">
    <div class="content-card" id="articleContainer">
      <div class="loading-overlay"><span class="spinner"></span> Loading article...</div>
    </div>

    <!-- Article History -->
    <div class="content-card mt-6 hidden" id="historySection">
      <h2 style="font-family:var(--font-serif); font-size:20px; margin-bottom:16px;">Edit History</h2>
      <div id="historyList" class="history-list"></div>
    </div>
  </main>

  <footer class="site-footer">
    <p>h8pedia &mdash; Built by students, for students.</p>
  </footer>

  <div class="toast-container" id="toastContainer"></div>

  <script src="js/firebase-api.js?v.1.1"></script>
  <script src="js/ban-system.js?v.1.1"></script>
  <script src="js/auth.js?v.1.1"></script>
  <script src="js/app.js?v.1.1"></script>
  <script>
    let currentArticle = null;
    let articleId = null;

    document.addEventListener("DOMContentLoaded", async () => {
      initNav();
      await BanSystem.init();

      articleId = getParam("id");
      if (!articleId) {
        document.getElementById("articleContainer").innerHTML = '<p class="text-muted text-center" style="padding:32px;">No article specified.</p>';
        return;
      }
      loadArticle(articleId);
    });

    async function loadArticle(id) {
      const container = document.getElementById("articleContainer");
      try {
        const article = await db.get(`/articles/${id}`);
        if (!article || article.deleted) {
          container.innerHTML = '<p class="text-muted text-center" style="padding:32px;">Article not found.</p>';
          document.title = "Not Found â€” h8pedia";
          return;
        }

        currentArticle = article;
        document.title = article.title + " â€” h8pedia";

        // Track view
        const views = (article.views || 0) + 1;
        db.update(`/articles/${id}`, { views });

        // Render markdown
        let bodyHtml = renderMarkdown(article.content || "");
        const tocResult = buildTOC(bodyHtml);
        let tocHtml = "";
        if (tocResult) {
          tocHtml = tocResult.toc;
          bodyHtml = tocResult.html;
        }

        // Check bookmark
        const user = Auth.getUser();
        let isBookmarked = false;
        if (user) {
          const bm = await db.get(`/users/${user}/bookmarks/${id}`);
          isBookmarked = !!bm;
        }

        // Actions
        const canEdit = Auth.isLoggedIn();
        const isMod = await Auth.isModerator();

        container.innerHTML = `
          <div class="article-header">
            <h1 class="article-title">${esc(article.title)}</h1>
            <div class="article-meta">
              <span>Created by <a href="profile.html?user=${encodeURIComponent(article.author)}">${esc(article.author)}</a></span>
              <span class="separator">|</span>
              <span>${formatDate(article.createdAt)}</span>
              ${article.lastEditor ? `<span class="separator">|</span><span>Last edited by <a href="profile.html?user=${encodeURIComponent(article.lastEditor)}">${esc(article.lastEditor)}</a></span>` : ''}
              ${article.category ? `<span class="separator">|</span><a href="categories.html?cat=${encodeURIComponent(article.category)}" class="chip" style="padding:2px 8px;font-size:11px;">${esc(article.category)}</a>` : ''}
              <span class="separator">|</span>
              <span>${views} views</span>
            </div>
          </div>

          <div class="article-actions">
            ${canEdit ? `<a href="editor.html?id=${encodeURIComponent(id)}" class="btn btn-secondary btn-sm">Edit Article</a>` : ''}
            ${user ? `<button class="btn btn-ghost btn-sm" onclick="toggleBookmark('${id}')" id="bookmarkBtn">${isBookmarked ? 'Bookmarked' : 'Bookmark'}</button>` : ''}
            <button class="btn btn-ghost btn-sm" onclick="toggleHistory()">History</button>
            ${isMod ? `<button class="btn btn-danger btn-sm" onclick="deleteArticle('${id}')">Delete</button>` : ''}
          </div>

          ${tocHtml}
          <div class="article-body">${bodyHtml}</div>

          <!-- Comments Section -->
          <div class="comments-section content-card mt-6">
            <h2 style="font-family:var(--font-serif); font-size:20px; margin-bottom:16px;">Comments</h2>
            <div id="commentsList" class="comments-list">
              <div class="loading-overlay"><span class="spinner"></span> Loading comments...</div>
            </div>
            ${Auth.isLoggedIn() ? `
              <div class="comment-form" style="margin-top:16px;">
                <textarea id="commentInput" rows="3" placeholder="Add a comment..." style="width:100%; padding:8px; border-radius:4px; border:1px solid var(--border);"></textarea>
                <button class="btn btn-primary btn-sm mt-2" onclick="postComment('${id}')">Post Comment</button>
              </div>
            ` : `<p class="text-muted mt-2">Log in to post comments.</p>`}
          </div>
        `;

        loadComments(id);

      } catch (err) {
        container.innerHTML = '<p class="text-muted text-center" style="padding:32px;">Failed to load article.</p>';
      }
    }

    async function toggleBookmark(id) {
      const user = Auth.getUser();
      if (!user) return;
      const existing = await db.get(`/users/${user}/bookmarks/${id}`);
      if (existing) {
        await db.delete(`/users/${user}/bookmarks/${id}`);
        document.getElementById("bookmarkBtn").textContent = "Bookmark";
        showToast("Bookmark removed", "success");
      } else {
        await db.set(`/users/${user}/bookmarks/${id}`, { savedAt: new Date().toISOString() });
        document.getElementById("bookmarkBtn").textContent = "Bookmarked";
        showToast("Article bookmarked!", "success");
      }
    }

    // -----------------------
    // Comments functions
    // -----------------------
    async function loadComments(articleId) {
      const list = document.getElementById("commentsList");
      list.innerHTML = '<div class="loading-overlay"><span class="spinner"></span> Loading comments...</div>';

      const commentsData = await db.get(`/articles/${articleId}/comments`);
      if (!commentsData) {
        list.innerHTML = '<p class="text-muted">No comments yet.</p>';
        return;
      }

      const comments = Object.entries(commentsData)
        .map(([cid, c]) => ({ id: cid, ...c }))
        .sort((a, b) => (a.createdAt || "").localeCompare(b.createdAt || ""));

      list.innerHTML = comments.map(c => `
        <div class="comment-item">
          <strong>${esc(c.author)}</strong> <span class="comment-time">${formatDateTime(c.createdAt)}</span>
          <p>${esc(c.text)}</p>
          ${Auth.isModerator() || Auth.getUser() === c.author ? `<button class="btn btn-ghost btn-sm mt-1" onclick="deleteComment('${articleId}','${c.id}')">Delete</button>` : ''}
        </div>
      `).join("");
    }
    const bannedWords = [
      "2g1c","2 girls 1 cup","acrotomophilia","alabama hot pocket","alaskan pipeline",
      "anal","anilingus","anus","apeshit","arsehole","ass","asshole","assmunch",
      "auto erotic","autoerotic","babeland","baby batter","baby juice","ball gag",
      "ball gravy","ball kicking","ball licking","ball sack","ball sucking","bangbros",
      "bangbus","bareback","barely legal","barenaked","bastard","bastardo","bastinado",
      "bbw","bdsm","beaner","beaners","beaver cleaver","beaver lips","beastiality",
      "bestiality","big black","big breasts","big knockers","big tits","bimbos",
      "birdlock","bitch","bitches","black cock","blonde action","blonde on blonde action",
      "blowjob","blow job","blow your load","blue waffle","blumpkin","bollocks",
      "bondage","boner","boob","boobs","booty call","brown showers","brunette action",
      "bukkake","bulldyke","bullet vibe","bullshit","bung hole","bunghole","busty",
      "butt","buttcheeks","butthole","camel toe","camgirl","camslut","camwhore",
      "carpet muncher","carpetmuncher","chocolate rosebuds","cialis","circlejerk",
      "cleveland steamer","clit","clitoris","clover clamps","clusterfuck","cock",
      "cocks","coprolagnia","coprophilia","cornhole","coon","coons","creampie","cum",
      "cumming","cumshot","cumshots","cunnilingus","cunt","darkie","date rape",
      "daterape","deep throat","deepthroat","dendrophilia","dick","dildo","dingleberry",
      "dingleberries","dirty pillows","dirty sanchez","doggie style","doggiestyle",
      "doggy style","doggystyle","dog style","dolcett","domination","dominatrix","dommes",
      "donkey punch","double dong","double penetration","dp action","dry hump","dvda",
      "eat my ass","ecchi","ejaculation","erotic","erotism","escort","eunuch","fag",
      "faggot","fecal","felch","fellatio","feltch","female squirting","femdom","figging",
      "fingerbang","fingering","fisting","foot fetish","footjob","frotting","fuck",
      "fuck buttons","fuckin","fucking","fucktards","fudge packer","fudgepacker","futanari",
      "gangbang","gang bang","gay sex","genitals","giant cock","girl on","girl on top",
      "girls gone wild","goatcx","goatse","god damn","gokkun","golden shower","goodpoop",
      "goo girl","goregasm","grope","group sex","g-spot","guro","hand job","handjob",
      "hard core","hardcore","hentai","homoerotic","honkey","hooker","horny","hot carl",
      "hot chick","how to kill","how to murder","huge fat","humping","incest","intercourse",
      "jack off","jail bait","jailbait","jelly donut","jerk off","jigaboo","jiggaboo",
      "jiggerboo","jizz","juggs","kike","kinbaku","kinkster","kinky","knobbing",
      "leather restraint","leather straight jacket","lemon party","livesex","lolita",
      "lovemaking","make me come","male squirting","masturbate","masturbating","masturbation",
      "menage a trois","milf","missionary position","mong","motherfucker","mound of venus",
      "mr hands","muff diver","muffdiving","nambla","nawashi","negro","neonazi","nigga",
      "nigger","nig nog","nimphomania","nipple","nipples","nsfw","nsfw images","nude",
      "nudity","nutten","nympho","nymphomania","octopussy","omorashi","one cup two girls",
      "one guy one jar","orgasm","orgy","paedophile","paki","panties","panty","pedobear",
      "pedophile","pegging","penis","phone sex","piece of shit","pikey","pissing","piss pig",
      "pisspig","playboy","pleasure chest","pole smoker","ponyplay","poof","poon","poontang",
      "punany","poop chute","poopchute","porn","porno","pornography","prince albert piercing",
      "pthc","pubes","pussy","queaf","queef","quim","raghead","raging boner","rape","raping",
      "rapist","rectum","reverse cowgirl","rimjob","rimming","rosy palm","rosy palm and her 5 sisters",
      "rusty trombone","sadism","santorum","scat","schlong","scissoring","semen","sex","sexcam",
      "sexo","sexy","sexual","sexually","sexuality","shaved beaver","shaved pussy","shemale",
      "shibari","shit","shitblimp","shitty","shota","shrimping","skeet","slanteye","slut","s&m",
      "smut","snatch","snowballing","sodomize","sodomy","spastic","spic","splooge","splooge moose",
      "spooge","spread legs","spunk","strap on","strapon","strappado","strip club","style doggy",
      "suck","sucks","suicide girls","sultry women","swastika","swinger","tainted love","taste my",
      "tea bagging","threesome","throating","thumbzilla","tied up","tight white","tit","tits",
      "titties","titty","tongue in a","topless","tosser","towelhead","tranny","tribadism","tub girl",
      "tubgirl","tushy","twat","twink","twinkie","two girls one cup","undressing","upskirt","urethra play",
      "urophilia","vagina","venus mound","viagra","vibrator","violet wand","vorarephilia","voyeur",
      "voyeurweb","voyuer","vulva","wank","wetback","wet dream","white power","whore","worldsex",
      "wrapping men","wrinkled starfish","xx","xxx","yaoi","yellow showers","yiffy","zoophilia","ðŸ–•"
    ];
    
    // Map common replacements
    const leetMap = {
      a: "[a@4]",
      b: "[b8]",
      c: "[c(\\{<]",
      e: "[e3]",
      g: "[g9]",
      i: "[i1!|]",
      l: "[l1|!]",
      o: "[o0]",
      s: "[s$5]",
      t: "[t7+]",
      z: "[z2]"
    };
    
    // Convert banned words into regex patterns with replacements
    const bannedRegex = new RegExp(
      bannedWords.map(word => {
        return word.split("").map(c => leetMap[c.toLowerCase()] || c).join("");
      }).join("|"),
      "i"
    );
    
    // Comment submission logic
    async function postComment(articleId) {
      const input = document.getElementById("commentInput");
      const text = input.value.trim();
    
      if (!text) return alert("Comment cannot be empty.");
      if (text.length > 100) return alert("Comment must be 100 characters or less.");
      if (bannedRegex.test(text)) return alert("Your comment contains prohibited language.");
    
      const user = Auth.getUser();
      if (!user) return alert("You must be logged in to post comments.");
    
      await db.push(`/articles/${articleId}/comments`, {
        author: user,
        text,
        createdAt: new Date().toISOString()
      });
    
      input.value = "";
      loadComments(articleId);
      showToast("Comment posted!", "success");
    }


    async function deleteComment(articleId, commentId) {
      if (!confirm("Delete this comment?")) return;
      await db.delete(`/articles/${articleId}/comments/${commentId}`);
      loadComments(articleId);
    }

    // -----------------------
    // History & Delete
    // -----------------------
    async function toggleHistory() {
      const section = document.getElementById("historySection");
      if (!section.classList.contains("hidden")) {
        section.classList.add("hidden");
        return;
      }
      section.classList.remove("hidden");
      const list = document.getElementById("historyList");
      list.innerHTML = '<div class="loading-overlay"><span class="spinner"></span></div>';

      const history = await db.get(`/articles/${articleId}/history`);
      if (!history) {
        list.innerHTML = '<p class="text-muted">No edit history yet.</p>';
        return;
      }

      const arr = Object.entries(history)
        .map(([hid, h]) => ({ id: hid, ...h }))
        .sort((a, b) => (b.editedAt || "").localeCompare(a.editedAt || ""));

      const isMod = await Auth.isModerator();

      list.innerHTML = arr.map(h => `
        <div class="history-item">
          <span class="history-dot"></span>
          <div>
            <div>
              <a href="profile.html?user=${encodeURIComponent(h.editor)}">${esc(h.editor)}</a>
              edited this article
              ${h.summary ? ` &mdash; <em>${esc(h.summary)}</em>` : ''}
            </div>
            <div class="history-time">${formatDateTime(h.editedAt)}</div>
            ${isMod ? `<button class="btn btn-ghost btn-sm mt-2" onclick="revertTo('${h.id}')">Revert to this version</button>` : ''}
          </div>
        </div>
      `).join("");
    }

    async function revertTo(historyId) {
      if (!confirm("Are you sure you want to revert to this version?")) return;
      const historyEntry = await db.get(`/articles/${articleId}/history/${historyId}`);
      if (!historyEntry) return alert("History entry not found.");

      // Save current as history first
      const current = await db.get(`/articles/${articleId}`);
      const user = Auth.getUser();
      await db.push(`/articles/${articleId}/history`, {
        editor: user,
        content: current.content,
        title: current.title,
        summary: "Before revert",
        editedAt: new Date().toISOString(),
      });

      // Revert
      await db.update(`/articles/${articleId}`, {
        content: historyEntry.content,
        title: historyEntry.title || current.title,
        lastEditor: user,
        updatedAt: new Date().toISOString(),
      });

      // Log activity
      await db.push("/activity", {
        type: "revert",
        articleId,
        user,
        revertedTo: historyId,
        timestamp: new Date().toISOString(),
      });

      showToast("Article reverted!", "success");
      loadArticle(articleId);
    }

    async function deleteArticle(id) {
      if (!confirm("Are you sure you want to delete this article?")) return;
      await db.update(`/articles/${id}`, { deleted: true, deletedAt: new Date().toISOString(), deletedBy: Auth.getUser() });
      await db.push("/activity", {
        type: "delete",
        articleId: id,
        user: Auth.getUser(),
        timestamp: new Date().toISOString(),
      });
      showToast("Article deleted", "success");
      setTimeout(() => location.href = "index.html", 1000);
    }

    function doSearch() {
      const q = document.getElementById("headerSearch").value.trim();
      if (q) location.href = `search.html?q=${encodeURIComponent(q)}`;
    }
    document.getElementById("headerSearch")?.addEventListener("keydown", e => { if (e.key === "Enter") doSearch(); });
  </script>
</body>
</html>
